<!DOCTYPE HTML>

<html>
    <head>
        <script type="application/ld+json">
    {
        "@context" : "http://schema.org",
        "@type" : "BlogPosting",
        "mainEntityOfPage": {
             "@type": "WebPage",
             "@id": ""
        },
        "articleSection" : "",
        "name" : "Jerome Brette&#39;s Blog",
        "headline" : "Jerome Brette&#39;s Blog",
        "description" : "",
        "inLanguage" : "en",
        "author" : "",
        "creator" : "",
        "publisher": "",
        "accountablePerson" : "",
        "copyrightHolder" : "",
        "copyrightYear" : "2018",
        "datePublished": "2018-09-29 00:00:00 &#43;0000 UTC",
        "dateModified" : "2018-09-29 00:00:00 &#43;0000 UTC",
        "url" : "/",
        "wordCount" : "0",
        "keywords" : [ "Blog" ]
    }
    </script>
        
            
                <title>Jerome Brette&#39;s Blog</title>
            
        

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="generator" content="Hugo 0.46" />
        


        
        
            
                <meta name="description" content="Jerome Brette&#39;s Blog">
            
        

        <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Jerome Brette&#39;s Blog"/>
<meta name="twitter:description" content="Jerome Brette&#39;s Blog"/>
<meta name="twitter:site" content="@example"/>

        <meta property="og:title" content="Jerome Brette&#39;s Blog" />
<meta property="og:description" content="Jerome Brette&#39;s Blog" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/" />



<meta property="og:updated_time" content="2018-09-29T00:00:00&#43;00:00"/>










        <meta property="og:image" content="/images/logo.png">
        <meta property="og:image:type" content="image/png">
        <meta property="og:image:width" content="512">
        <meta property="og:image:height" content="512">
        
<meta itemprop="name" content="Jerome Brette&#39;s Blog">
<meta itemprop="description" content="Jerome Brette&#39;s Blog">


        

        
            
        

        
        
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">
            <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,800,900|Source+Sans+Pro:400,700">
            <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.25/jquery.fancybox.min.css">
            <link rel="stylesheet" href="/css/main.css">
            <link rel="stylesheet" href="/css/add-on.css">
            <link rel="stylesheet" href="/css/academicons.min.css">
        

        
            
                
            
        


  
    
    <link href='//cdn.bootcss.com/highlight.js/9.11.0/styles/github.min.css' rel='stylesheet' type='text/css' />
  


      
<script>
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-123357787-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    </head>
    <body>

      
      <div id="wrapper">

    
    
<header id="header">
    
      <h1><a href="/">building my edge network</a></h1>
    

    <nav class="links">
        <ul>
            
                <li>
                    <a href="/">
                            <i class="fa fa-home">&nbsp;</i>Home
                    </a>
                </li>
            
                <li>
                    <a href="/about/">
                            <i class="fa fa-id-card-o">&nbsp;</i>About
                    </a>
                </li>
            
                <li>
                    <a href="/post/">
                            <i class="fa fa-newspaper-o">&nbsp;</i>Blog
                    </a>
                </li>
            
                <li>
                    <a href="/tags/">
                            <i class="fa fa-list">&nbsp;</i>Tags
                    </a>
                </li>
            
                <li>
                    <a href="/categories/">
                            <i class="fa fa-sitemap">&nbsp;</i>Categories
                    </a>
                </li>
            
        </ul>
    </nav>
    <nav class="main">
        <ul>
            
            <li id="share-nav" class="share-menu" style="display:none;">
                <a class="fa-share-alt" href="#share-menu">Share</a>
            </li>
            
            <li class="search">
                <a class="fa-search" href="#search">Search</a>
                <form id="search" method="get" action="//google.com/search">
                    <input type="text" name="q" placeholder="Search" />
                    <input type="hidden" name="as_sitesearch" value="">
                </form>
            </li>
            <li class="menu">
                <a class="fa-bars" href="#menu">Menu</a>
            </li>
        </ul>
    </nav>
</header>


<section id="menu">

    
        <section>
            <form class="search" method="get" action="//google.com/search">
                <input type="text" name="q" placeholder="Search" />
                <input type="hidden" name="as_sitesearch" value="">
            </form>
        </section>

    
        <section>
            <ul class="links">
                
                    <li>
                        <a href="/">
                            <h3>
                                <i class="fa fa-home">&nbsp;</i>Home
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/about/">
                            <h3>
                                <i class="fa fa-id-card-o">&nbsp;</i>About
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/post/">
                            <h3>
                                <i class="fa fa-newspaper-o">&nbsp;</i>Blog
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags/">
                            <h3>
                                <i class="fa fa-list">&nbsp;</i>Tags
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories/">
                            <h3>
                                <i class="fa fa-sitemap">&nbsp;</i>Categories
                            </h3>
                        </a>
                    </li>
                
            </ul>
        </section>

    
        <section class="recent-posts">
            <div class="mini-posts">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                

                
                    
                

                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/post/2018-09-28-a/">Upgrade RPI Kubernetes cluster to 1.12</a></h3>
                                
                                <time class="published" datetime=
                                    '2018-09-29'>
                                    September 29, 2018</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/post/2018-08-01-a/">Build and Deploy Kubernetes Hashicorp Vault</a></h3>
                                
                                <time class="published" datetime=
                                    '2018-08-01'>
                                    August 1, 2018</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/post/2018-07-31-a/">Build and Deploy Kubernetes Istio</a></h3>
                                
                                <time class="published" datetime=
                                    '2018-07-31'>
                                    July 31, 2018</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/post/2018-07-30-a/">Build and Deploy Kubernetes test-infra</a></h3>
                                
                                <time class="published" datetime=
                                    '2018-07-30'>
                                    July 30, 2018</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/post/2018-07-29-a/">Build and Deploy Kubernetes Kustomize</a></h3>
                                
                                <time class="published" datetime=
                                    '2018-07-29'>
                                    July 29, 2018</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/post/2018-07-28-a/">Deploy Cassandra on Raspberry-PI 3</a></h3>
                                
                                <time class="published" datetime=
                                    '2018-07-28'>
                                    July 28, 2018</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/post/2018-07-19-a/">Build and Deploy MachineLearning Kubeflow Framework</a></h3>
                                
                                <time class="published" datetime=
                                    '2018-07-19'>
                                    July 19, 2018</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/post/2018-07-18-a/">Compile and Test Portieris</a></h3>
                                
                                <time class="published" datetime=
                                    '2018-07-18'>
                                    July 18, 2018</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/post/2018-07-17-a/">Rebuild Calico for AMD64 ad ARM32V7</a></h3>
                                
                                <time class="published" datetime=
                                    '2018-07-17'>
                                    July 17, 2018</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/post/2018-07-16-a/">Rebuild Hyperkube images</a></h3>
                                
                                <time class="published" datetime=
                                    '2018-07-16'>
                                    July 16, 2018</time>
                            </header>
                            

                        </article>
                

                
                    <a href=
                        
                            /post/
                        
                        class="button">View more posts</a>
                
            </div>
        </section>

    
        
</section>

    
    <div id="main">
        
            <article class="post">
  <header>
    <div class="title">
        
            <h2><a href="/post/2018-09-28-a/">Upgrade RPI Kubernetes cluster to 1.12</a></h2>
        
        
    </div>
    <div class="meta">
        

        <time class="published"
            datetime='2018-09-29'>
            September 29, 2018</time>
        <span class="author"></span>
        
            <p>10 minute read</p>
        
        
    </div>
</header>


  
    <section id="social-share">
      <ul class="icons">
        



<li>
  <a href="//twitter.com/share?url=%2fpost%2f2018-09-28-a%2f&amp;text=Upgrade%20RPI%20Kubernetes%20cluster%20to%201.12&amp;via=example" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
    </a>
</li>




<li>
  <a href="//plus.google.com/share?url=%2fpost%2f2018-09-28-a%2f" target="_blank" class="share-btn google-plus">
    <i class="fa fa-google-plus"></i>
    <p>Google+</p>
  </a>
</li>





<li>
  <a href="//www.facebook.com/sharer/sharer.php?u=%2fpost%2f2018-09-28-a%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
    </a>
</li>




<li>
  <a href="//reddit.com/submit?url=%2fpost%2f2018-09-28-a%2f&amp;title=Upgrade%20RPI%20Kubernetes%20cluster%20to%201.12" target="_blank" class="share-btn reddit">
    <i class="fa fa-reddit-alien"></i>
    <p>Reddit</p>
  </a>
</li>




<li>
  <a href="//www.linkedin.com/shareArticle?url=%2fpost%2f2018-09-28-a%2f&amp;title=Upgrade%20RPI%20Kubernetes%20cluster%20to%201.12" target="_blank" class="share-btn linkedin">
      <i class="fa fa-linkedin"></i>
      <p>LinkedIn</p>
    </a>
</li>




<li>
  <a href="//www.stumbleupon.com/submit?url=%2fpost%2f2018-09-28-a%2f&amp;title=Upgrade%20RPI%20Kubernetes%20cluster%20to%201.12" target="_blank" class="share-btn stumbleupon">
    <i class="fa fa-stumbleupon"></i>
    <p>StumbleUpon</p>
  </a>
</li>




<li>
  <a href="//www.pinterest.com/pin/create/button/?url=%2fpost%2f2018-09-28-a%2f&amp;description=Upgrade%20RPI%20Kubernetes%20cluster%20to%201.12" target="_blank" class="share-btn pinterest">
    <i class="fa fa-pinterest-p"></i>
    <p>Pinterest</p>
  </a>
</li>




<li>
  <a href="mailto:?subject=Check out this post by &amp;body=%2fpost%2f2018-09-28-a%2f" target="_blank" class="share-btn email">
    <i class="fa fa-envelope"></i>
    <p>Email</p>
  </a>
</li>


      </ul>
    </section>
  

  

  <div id="content">
    

<h1 id="goal">Goal</h1>

<p>The new Kubernetes 1.12 is out. THe goal is to update my two clusters to 1.12
using kubeadm 1.12</p>

<h2 id="master-node-upgrade-using-kubeadm">Master node upgrade using kubeadm</h2>

<pre><code class="language-bash"># apt-mark unhold kubeadm &amp;&amp; \
&gt; apt-get update &amp;&amp; apt-get install -y kubeadm &amp;&amp; \
&gt; apt-mark hold kubeadm
kubeadm was already not hold.
Hit:2 http://raspbian.raspberrypi.org/raspbian stretch InRelease
Hit:3 https://download.docker.com/linux/raspbian stretch InRelease
Hit:1 https://packages.cloud.google.com/apt kubernetes-xenial InRelease
Hit:5 http://archive.raspberrypi.org/debian stretch InRelease
Hit:4 https://packagecloud.io/Hypriot/rpi/debian stretch InRelease
Reading package lists... Done
Reading package lists... Done
Building dependency tree
Reading state information... Done
The following packages will be upgraded:
  kubeadm
1 upgraded, 0 newly installed, 0 to remove and 38 not upgraded.
Need to get 8,095 kB of archives.
After this operation, 3,100 kB disk space will be freed.
Get:1 https://packages.cloud.google.com/apt kubernetes-xenial/main armhf kubeadm armhf 1.12.0-00 [8,095 kB]
Fetched 8,095 kB in 4s (1,962 kB/s)
(Reading database ... 30574 files and directories currently installed.)
Preparing to unpack .../kubeadm_1.12.0-00_armhf.deb ...
Unpacking kubeadm (1.12.0-00) over (1.11.1-00) ...
Setting up kubeadm (1.12.0-00) ...
kubeadm set on hold.
</code></pre>

<pre><code class="language-bash">sudo kubeadm upgrade plan
[preflight] Running pre-flight checks.
[upgrade] Making sure the cluster is healthy:
[upgrade/config] Making sure the configuration is correct:
[upgrade/config] Reading configuration from the cluster...
[upgrade/config] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'
[upgrade] Fetching available versions to upgrade to
[upgrade/versions] Cluster version: v1.11.0
[upgrade/versions] kubeadm version: v1.12.0
[upgrade/versions] Latest stable version: v1.12.0
[upgrade/versions] Latest version in the v1.11 series: v1.11.3

Components that must be upgraded manually after you have upgraded the control plane with 'kubeadm upgrade apply':
COMPONENT   CURRENT       AVAILABLE
Kubelet     3 x v1.11.1   v1.11.3

Upgrade to the latest version in the v1.11 series:

COMPONENT            CURRENT   AVAILABLE
API Server           v1.11.0   v1.11.3
Controller Manager   v1.11.0   v1.11.3
Scheduler            v1.11.0   v1.11.3
Kube Proxy           v1.11.0   v1.11.3
CoreDNS              1.1.3     1.2.2
Etcd                 3.2.18    3.2.18

You can now apply the upgrade by executing the following command:

        kubeadm upgrade apply v1.11.3

_____________________________________________________________________

Components that must be upgraded manually after you have upgraded the control plane with 'kubeadm upgrade apply':
COMPONENT   CURRENT       AVAILABLE
Kubelet     3 x v1.11.1   v1.12.0

Upgrade to the latest stable version:

COMPONENT            CURRENT   AVAILABLE
API Server           v1.11.0   v1.12.0
Controller Manager   v1.11.0   v1.12.0
Scheduler            v1.11.0   v1.12.0
Kube Proxy           v1.11.0   v1.12.0
CoreDNS              1.1.3     1.2.2
Etcd                 3.2.18    3.2.24

You can now apply the upgrade by executing the following command:

        kubeadm upgrade apply v1.12.0

_____________________________________________________________________
</code></pre>

<pre><code class="language-bash">$ sudo kubeadm upgrade apply v1.12.0
[preflight] Running pre-flight checks.
[upgrade] Making sure the cluster is healthy:
[upgrade/config] Making sure the configuration is correct:
[upgrade/config] Reading configuration from the cluster...
[upgrade/config] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'
[upgrade/apply] Respecting the --cri-socket flag that is set with higher priority than the config file.
[upgrade/version] You have chosen to change the cluster version to &quot;v1.12.0&quot;
[upgrade/versions] Cluster version: v1.11.0
[upgrade/versions] kubeadm version: v1.12.0
[upgrade/confirm] Are you sure you want to proceed with the upgrade? [y/N]: y
[upgrade/prepull] Will prepull images for components [kube-apiserver kube-controller-manager kube-scheduler etcd]
[upgrade/prepull] Prepulling image for component kube-apiserver.
[upgrade/prepull] Prepulling image for component kube-controller-manager.
[upgrade/prepull] Prepulling image for component kube-scheduler.
[upgrade/prepull] Prepulling image for component etcd.
[apiclient] Found 0 Pods for label selector k8s-app=upgrade-prepull-kube-apiserver
[apiclient] Found 0 Pods for label selector k8s-app=upgrade-prepull-etcd
[apiclient] Found 0 Pods for label selector k8s-app=upgrade-prepull-kube-controller-manager
[apiclient] Found 0 Pods for label selector k8s-app=upgrade-prepull-kube-scheduler
[apiclient] Found 1 Pods for label selector k8s-app=upgrade-prepull-kube-scheduler
[apiclient] Found 1 Pods for label selector k8s-app=upgrade-prepull-kube-apiserver
[apiclient] Found 1 Pods for label selector k8s-app=upgrade-prepull-kube-controller-manager
[apiclient] Found 1 Pods for label selector k8s-app=upgrade-prepull-etcd
[upgrade/prepull] Prepulled image for component etcd.
[upgrade/prepull] Prepulled image for component kube-apiserver.
[upgrade/prepull] Prepulled image for component kube-controller-manager.
[upgrade/prepull] Prepulled image for component kube-scheduler.
[upgrade/prepull] Successfully prepulled the images for all the control plane components
[upgrade/apply] Upgrading your Static Pod-hosted control plane to version &quot;v1.12.0&quot;...
Static pod: kube-apiserver-master-pi hash: c30b2fa49c49e091538b2ce8e4dae186
Static pod: kube-controller-manager-master-pi hash: 22f67939f8b1abea8ba99666b78b5c93
Static pod: kube-scheduler-master-pi hash: 0e545194d6b033abd681f02dfd11f4c8
Static pod: etcd-master-pi hash: 00575b778fb80d4e48241f80ceb2ac0f
[etcd] Wrote Static Pod manifest for a local etcd instance to &quot;/etc/kubernetes/tmp/kubeadm-upgraded-manifests040184315/etcd.yaml&quot;
[upgrade/staticpods] Moved new manifest to &quot;/etc/kubernetes/manifests/etcd.yaml&quot; and backed up old manifest to &quot;/etc/kubernetes/tmp/kubeadm-backup-manifests-2018-09-30-00-46-56/etcd.yaml&quot;
[upgrade/staticpods] Waiting for the kubelet to restart the component
[upgrade/staticpods] This might take a minute or longer depending on the component/version gap (timeout 5m0s
Static pod: etcd-master-pi hash: 00575b778fb80d4e48241f80ceb2ac0f
Static pod: etcd-master-pi hash: 00575b778fb80d4e48241f80ceb2ac0f
Static pod: etcd-master-pi hash: 00575b778fb80d4e48241f80ceb2ac0f
Static pod: etcd-master-pi hash: 77c6076a4d6ee044b744b041125cf918
[apiclient] Found 1 Pods for label selector component=etcd
[upgrade/staticpods] Component &quot;etcd&quot; upgraded successfully!
[upgrade/etcd] Waiting for etcd to become available
[util/etcd] Waiting 0s for initial delay
[util/etcd] Attempting to see if all cluster endpoints are available 1/10
[upgrade/staticpods] Writing new Static Pod manifests to &quot;/etc/kubernetes/tmp/kubeadm-upgraded-manifests040184315&quot;
[controlplane] wrote Static Pod manifest for component kube-apiserver to &quot;/etc/kubernetes/tmp/kubeadm-upgraded-manifests040184315/kube-apiserver.yaml&quot;
[controlplane] wrote Static Pod manifest for component kube-controller-manager to &quot;/etc/kubernetes/tmp/kubeadm-upgraded-manifests040184315/kube-controller-manager.yaml&quot;
[controlplane] wrote Static Pod manifest for component kube-scheduler to &quot;/etc/kubernetes/tmp/kubeadm-upgraded-manifests040184315/kube-scheduler.yaml&quot;
[upgrade/staticpods] Moved new manifest to &quot;/etc/kubernetes/manifests/kube-apiserver.yaml&quot; and backed up old manifest to &quot;/etc/kubernetes/tmp/kubeadm-backup-manifests-2018-09-30-00-46-56/kube-apiserver.yaml&quot;
[upgrade/staticpods] Waiting for the kubelet to restart the component
[upgrade/staticpods] This might take a minute or longer depending on the component/version gap (timeout 5m0s
Static pod: kube-apiserver-master-pi hash: c30b2fa49c49e091538b2ce8e4dae186
Static pod: kube-apiserver-master-pi hash: a92106d6db4c8b5835a47f5f56c33fdb
[apiclient] Found 1 Pods for label selector component=kube-apiserver
[upgrade/staticpods] Component &quot;kube-apiserver&quot; upgraded successfully!
[upgrade/staticpods] Moved new manifest to &quot;/etc/kubernetes/manifests/kube-controller-manager.yaml&quot; and backed up old manifest to &quot;/etc/kubernetes/tmp/kubeadm-backup-manifests-2018-09-30-00-46-56/kube-controller-manager.yaml&quot;
[upgrade/staticpods] Waiting for the kubelet to restart the component
[upgrade/staticpods] This might take a minute or longer depending on the component/version gap (timeout 5m0s
Static pod: kube-controller-manager-master-pi hash: 22f67939f8b1abea8ba99666b78b5c93
Static pod: kube-controller-manager-master-pi hash: 980b4156606df8caafd0ad8abacc1485
[apiclient] Found 1 Pods for label selector component=kube-controller-manager
[upgrade/staticpods] Component &quot;kube-controller-manager&quot; upgraded successfully!
[upgrade/staticpods] Moved new manifest to &quot;/etc/kubernetes/manifests/kube-scheduler.yaml&quot; and backed up old manifest to &quot;/etc/kubernetes/tmp/kubeadm-backup-manifests-2018-09-30-00-46-56/kube-scheduler.yaml&quot;
[upgrade/staticpods] Waiting for the kubelet to restart the component
[upgrade/staticpods] This might take a minute or longer depending on the component/version gap (timeout 5m0s
Static pod: kube-scheduler-master-pi hash: 0e545194d6b033abd681f02dfd11f4c8
Static pod: kube-scheduler-master-pi hash: 1b5ec5be325bf29f60be62789416a99e
[apiclient] Found 1 Pods for label selector component=kube-scheduler
[upgrade/staticpods] Component &quot;kube-scheduler&quot; upgraded successfully!
[uploadconfig] storing the configuration used in ConfigMap &quot;kubeadm-config&quot; in the &quot;kube-system&quot; Namespace
[kubelet] Creating a ConfigMap &quot;kubelet-config-1.12&quot; in namespace kube-system with the configuration for the kubelets in the cluster
[kubelet] Downloading configuration for the kubelet from the &quot;kubelet-config-1.12&quot; ConfigMap in the kube-system namespace
[kubelet] Writing kubelet configuration to file &quot;/var/lib/kubelet/config.yaml&quot;
[patchnode] Uploading the CRI Socket information &quot;/var/run/dockershim.sock&quot; to the Node API object &quot;master-pi&quot; as an annotation
[bootstraptoken] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials
[bootstraptoken] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token
[bootstraptoken] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster
[addons] Applied essential addon: CoreDNS
[addons] Applied essential addon: kube-proxy

[upgrade/successful] SUCCESS! Your cluster was upgraded to &quot;v1.12.0&quot;. Enjoy!

[upgrade/kubelet] Now that your control plane is upgraded, please proceed with upgrading your kubelets if you haven't already done so.
</code></pre>

<p>Kubernetes servers are running v1.12</p>

<pre><code class="language-bash">$ kubectl version
Client Version: version.Info{Major:&quot;1&quot;, Minor:&quot;11&quot;, GitVersion:&quot;v1.11.1&quot;, GitCommit:&quot;b1b29978270dc22fecc592ac55d903350454310a&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2018-07-17T18:53:20Z&quot;, GoVersion:&quot;go1.10.3&quot;, Compiler:&quot;gc&quot;, Platform:&quot;linux/arm&quot;}
Server Version: version.Info{Major:&quot;1&quot;, Minor:&quot;12&quot;, GitVersion:&quot;v1.12.0&quot;, GitCommit:&quot;0ed33881dc4355495f623c6f22e7dd0b7632b7c0&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2018-09-27T16:55:41Z&quot;, GoVersion:&quot;go1.10.4&quot;, Compiler:&quot;gc&quot;, Platform:&quot;linux/arm&quot;}
</code></pre>

<p>my kubelets are still running kubernetes v1.11.1</p>

<pre><code class="language-bash">$ kubectl get nodes
NAME        STATUS    ROLES     AGE       VERSION
home-pi     Ready     &lt;none&gt;    86d       v1.11.1
master-pi   Ready     master    86d       v1.11.1
nas-pi      Ready     &lt;none&gt;    85d       v1.11.1
</code></pre>

<h2 id="upgrade-kubectl">Upgrade kubectl</h2>

<p>Install newer version of kubectl using apt-get</p>

<pre><code class="language-bash">$ sudo apt-get install kubectl
Reading package lists... Done
Building dependency tree
Reading state information... Done
The following packages will be upgraded:
  kubectl
1 upgraded, 0 newly installed, 0 to remove and 37 not upgraded.
Need to get 8,639 kB of archives.
After this operation, 1,783 kB of additional disk space will be used.
Get:1 https://packages.cloud.google.com/apt kubernetes-xenial/main armhf kubectl armhf 1.12.0-00 [8,639 kB]
Fetched 8,639 kB in 6s (1,270 kB/s)
(Reading database ... 30574 files and directories currently installed.)
Preparing to unpack .../kubectl_1.12.0-00_armhf.deb ...
Unpacking kubectl (1.12.0-00) over (1.11.1-00) ...
Setting up kubectl (1.12.0-00) ...
</code></pre>

<p>Check that kubectl is now 1.12</p>

<pre><code class="language-bash">$ kubectl version
Client Version: version.Info{Major:&quot;1&quot;, Minor:&quot;12&quot;, GitVersion:&quot;v1.12.0&quot;, GitCommit:&quot;0ed33881dc4355495f623c6f22e7dd0b7632b7c0&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2018-09-27T17:05:32Z&quot;, GoVersion:&quot;go1.10.4&quot;, Compiler:&quot;gc&quot;, Platform:&quot;linux/arm&quot;}
Server Version: version.Info{Major:&quot;1&quot;, Minor:&quot;12&quot;, GitVersion:&quot;v1.12.0&quot;, GitCommit:&quot;0ed33881dc4355495f623c6f22e7dd0b7632b7c0&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2018-09-27T16:55:41Z&quot;, GoVersion:&quot;go1.10.4&quot;, Compiler:&quot;gc&quot;, Platform:&quot;linux/arm&quot;}
</code></pre>

<h2 id="upgrade-kubelet-on-master-node">Upgrade kubelet on master node</h2>

<pre><code class="language-bash">$ sudo apt-get upgrade -y kubelet
Reading package lists... Done
Building dependency tree
Reading state information... Done
Calculating upgrade... Done
The following packages will be upgraded:
...
</code></pre>

<pre><code class="language-bash">$ sudo systemctl restart kubelet
</code></pre>

<pre><code class="language-bash">$ kubectl get nodes
NAME        STATUS   ROLES    AGE   VERSION
home-pi     Ready    &lt;none&gt;   86d   v1.11.1
master-pi   Ready    master   86d   v1.12.0
nas-pi      Ready    &lt;none&gt;   85d   v1.11.1
</code></pre>

<p>Looks that as useual something is wrong with flannel CNI</p>

<pre><code class="language-bash">$ kubectl get all --all-namespaces
NAMESPACE     NAME                                             READY   STATUS    RESTARTS   AGE
default       pod/helm-rpi-kubeplay-arm32v7-6cb66496c6-6gvf6   1/1     Running   0          60d
kube-system   pod/coredns-576cbf47c7-nzhfj                     1/1     Running   0          37m
kube-system   pod/coredns-576cbf47c7-wkmhr                     1/1     Running   0          37m
kube-system   pod/etcd-master-pi                               1/1     Running   0          3m43s
kube-system   pod/kube-apiserver-master-pi                     1/1     Running   2          3m43s
kube-system   pod/kube-controller-manager-master-pi            1/1     Running   1          3m43s
kube-system   pod/kube-flannel-ds-4495g                        1/1     Running   4          75d
kube-system   pod/kube-flannel-ds-52ssk                        0/1     Error     10         75d
kube-system   pod/kube-flannel-ds-gj65n                        1/1     Running   4          75d

Investigation shows:

```bash
$ kubectl logs pod/kube-flannel-ds-52ssk -n kube-system
I0930 01:34:13.768925       1 main.go:475] Determining IP address of default interface
I0930 01:34:13.778622       1 main.go:488] Using interface with name wlan0 and address 192.168.1.95
I0930 01:34:13.778716       1 main.go:505] Defaulting external address to interface address (192.168.1.95)
I0930 01:34:14.168318       1 kube.go:131] Waiting 10m0s for node controller to sync
I0930 01:34:14.168890       1 kube.go:294] Starting kube subnet manager
I0930 01:34:15.169929       1 kube.go:138] Node controller sync successful
I0930 01:34:15.170035       1 main.go:235] Created subnet manager: Kubernetes Subnet Manager - master-pi
I0930 01:34:15.170064       1 main.go:238] Installing signal handlers
I0930 01:34:15.170415       1 main.go:353] Found network config - Backend type: vxlan
I0930 01:34:15.170797       1 vxlan.go:120] VXLAN config: VNI=1 Port=0 GBP=false DirectRouting=false
E0930 01:34:15.256843       1 main.go:280] Error registering network: failed to configure interface flannel.1: failed to ensure address of interface flannel.1: link has incompatible addresses. Remove additional addresses and try again. &amp;netlink.Vxlan{LinkAttrs:netlink.LinkAttrs{Index:5, MTU:1450, TxQLen:0, Name:&quot;flannel.1&quot;, HardwareAddr:net.HardwareAddr{0x26, 0xd5, 0xd0, 0xdd, 0x56, 0x1a},
...
</code></pre>

<p>Let&rsquo;s apply usual receipe
``bash
sudo ip link delete flannel.1</p>

<pre><code>
Brute force fix seems to have done the fix....This is lucky we don't have production traffic on that node.
```bash
$ kubectl get pods -n kube-system
NAME                                    READY   STATUS    RESTARTS   AGE
coredns-576cbf47c7-nzhfj                1/1     Running   0          51m
coredns-576cbf47c7-wkmhr                1/1     Running   0          51m
etcd-master-pi                          1/1     Running   0          17m
kube-apiserver-master-pi                1/1     Running   2          17m
kube-controller-manager-master-pi       1/1     Running   1          17m
kube-flannel-ds-4495g                   1/1     Running   4          75d
kube-flannel-ds-52ssk                   1/1     Running   13         75d
kube-flannel-ds-gj65n                   1/1     Running   4          75d
kube-proxy-c2264                        1/1     Running   0          51m
kube-proxy-snjsg                        1/1     Running   0          49m
kube-proxy-zgqjb                        1/1     Running   1          50m
kube-scheduler-master-pi                1/1     Running   1          17m
kubernetes-dashboard-7d59788d44-rchkk   1/1     Running   25         83d
tiller-deploy-b59fcc885-dbvlv           1/1     Running   0          60d
</code></pre>

<h2 id="update-first-slave-node">Update first slave node</h2>

<pre><code class="language-bash">sudo apt-get clean
sudo apt-get update
sudo apt-get install kubeadm
sudo apt-get install kubelet
sudo kubeadm upgrade node config --kubelet-version $(kubelet --version | cut -d ' ' -f 2)
sudo systemctl restart kubelet
</code></pre>

<p>Same flannel issue</p>

<pre><code class="language-bash">$ kubectl get pods -n kube-system
NAME                                    READY   STATUS             RESTARTS   AGE
coredns-576cbf47c7-nzhfj                1/1     Running            0          87m
coredns-576cbf47c7-wkmhr                1/1     Running            1          87m
etcd-master-pi                          1/1     Running            0          53m
kube-apiserver-master-pi                1/1     Running            2          53m
kube-controller-manager-master-pi       1/1     Running            1          53m
kube-flannel-ds-4495g                   0/1     CrashLoopBackOff   10         75d
...
</code></pre>

<p>same hack to fix the issue</p>

<pre><code class="language-bash">sudo ip link delete flannel.1
</code></pre>

<p>same hack seems to be effective</p>

<pre><code class="language-bash">$ kubectl get pods -n kube-system
NAME                                    READY   STATUS    RESTARTS   AGE
coredns-576cbf47c7-nzhfj                1/1     Running   0          111m
coredns-576cbf47c7-wkmhr                1/1     Running   1          111m
etcd-master-pi                          1/1     Running   0          77m
kube-apiserver-master-pi                1/1     Running   2          77m
kube-controller-manager-master-pi       1/1     Running   1          77m
kube-flannel-ds-4495g                   1/1     Running   11         75d
...
</code></pre>

<h3 id="other-slave-node">Other slave node</h3>

<pre><code>sudo apt-get clean
sudo apt-get update
sudo apt-get install kubeadm
sudo apt-get install kubelet
sudo kubeadm upgrade node config --kubelet-version $(kubelet --version | cut -d ' ' -f 2)
sudo systemctl restart kubelet
sudo ip link delete flannel.1
</code></pre>

<h2 id="check-consistency-of-the-cluster">Check consistency of the cluster</h2>

<pre><code class="language-bash">$ kubectl get pods -n kube-system
NAME                                    READY   STATUS    RESTARTS   AGE
coredns-576cbf47c7-nzhfj                1/1     Running   1          143m
coredns-576cbf47c7-wkmhr                1/1     Running   1          143m
etcd-master-pi                          1/1     Running   0          109m
kube-apiserver-master-pi                1/1     Running   2          109m
kube-controller-manager-master-pi       1/1     Running   1          109m
kube-flannel-ds-4495g                   1/1     Running   11         76d
kube-flannel-ds-52ssk                   1/1     Running   13         76d
kube-flannel-ds-gj65n                   1/1     Running   13         76d
kube-proxy-c2264                        1/1     Running   1          143m
kube-proxy-snjsg                        1/1     Running   1          141m
kube-proxy-zgqjb                        1/1     Running   1          142m
kube-scheduler-master-pi                1/1     Running   1          109m
kubernetes-dashboard-7d59788d44-rchkk   1/1     Running   25         83d
tiller-deploy-b59fcc885-dbvlv           1/1     Running   0          60d
</code></pre>

<pre><code class="language-bash">$ kubectl get nodes
NAME        STATUS   ROLES    AGE   VERSION
home-pi     Ready    &lt;none&gt;   86d   v1.12.0
master-pi   Ready    master   86d   v1.12.0
nas-pi      Ready    &lt;none&gt;   86d   v1.12.0
</code></pre>

<h2 id="conclusion">Conclusion</h2>

<ul>
<li>At a glance, the cluster seems to be healthy</li>
<li>I still need to find sometool like sonobuoy to validate that the cluster is healthy</li>
</ul>

<h2 id="reference-links">Reference Links</h2>

<ul>
<li><a href="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade-1-12/">Official Upgrade documentation</a></li>
</ul>

  </div>

  <footer>
    <ul class="stats">
  <li class="categories">
    <ul>
        
            
            
                <i class="fa fa-folder"></i>
                
                
                <li><a class="article-category-link" href="categories/wiki">wiki</a></li>
                
                
                <li><a class="article-category-link" href="categories/wip">wip</a></li>
                
            
        
    </ul>
  </li>
  <li class="tags">
    <ul>
        
            
            
                <i class="fa fa-tags"></i>
                
                
                <li><a class="article-category-link" href="tags/kubernetes">kubernetes</a></li>
                
                
                <li><a class="article-category-link" href="tags/rpi">rpi</a></li>
                
            
        
    </ul>
  </li>
</ul>

  </footer>

</article>

    <article class="post">
        <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "jbrette" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </article>


<ul class="actions pagination">
    
        <li><a href="/post/2018-08-01-a/"
                class="button big previous">Build and Deploy Kubernetes Hashicorp Vault</a></li>
    

    
</ul>



            <section id="share-menu">
    <section id="social-share-nav">
        <ul class="links">
            <header>
                <h3>Share this post <i class="fa fa-smile-o"></i></h3>
            </header>
            



<li>
  <a href="//twitter.com/share?url=%2fpost%2f2018-09-28-a%2f&amp;text=Upgrade%20RPI%20Kubernetes%20cluster%20to%201.12&amp;via=example" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
    </a>
</li>




<li>
  <a href="//plus.google.com/share?url=%2fpost%2f2018-09-28-a%2f" target="_blank" class="share-btn google-plus">
    <i class="fa fa-google-plus"></i>
    <p>Google+</p>
  </a>
</li>





<li>
  <a href="//www.facebook.com/sharer/sharer.php?u=%2fpost%2f2018-09-28-a%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
    </a>
</li>




<li>
  <a href="//reddit.com/submit?url=%2fpost%2f2018-09-28-a%2f&amp;title=Upgrade%20RPI%20Kubernetes%20cluster%20to%201.12" target="_blank" class="share-btn reddit">
    <i class="fa fa-reddit-alien"></i>
    <p>Reddit</p>
  </a>
</li>




<li>
  <a href="//www.linkedin.com/shareArticle?url=%2fpost%2f2018-09-28-a%2f&amp;title=Upgrade%20RPI%20Kubernetes%20cluster%20to%201.12" target="_blank" class="share-btn linkedin">
      <i class="fa fa-linkedin"></i>
      <p>LinkedIn</p>
    </a>
</li>




<li>
  <a href="//www.stumbleupon.com/submit?url=%2fpost%2f2018-09-28-a%2f&amp;title=Upgrade%20RPI%20Kubernetes%20cluster%20to%201.12" target="_blank" class="share-btn stumbleupon">
    <i class="fa fa-stumbleupon"></i>
    <p>StumbleUpon</p>
  </a>
</li>




<li>
  <a href="//www.pinterest.com/pin/create/button/?url=%2fpost%2f2018-09-28-a%2f&amp;description=Upgrade%20RPI%20Kubernetes%20cluster%20to%201.12" target="_blank" class="share-btn pinterest">
    <i class="fa fa-pinterest-p"></i>
    <p>Pinterest</p>
  </a>
</li>




<li>
  <a href="mailto:?subject=Check out this post by &amp;body=%2fpost%2f2018-09-28-a%2f" target="_blank" class="share-btn email">
    <i class="fa fa-envelope"></i>
    <p>Email</p>
  </a>
</li>


        </ul>
    </section>
</section>

        
    </div>
    
<section id="sidebar">

  
  <section id="intro">
    
    
      
        <a href='/'><img src="/images/logo.png" class="intro-circle" width="" alt="avatar" /></a>
      
    
    
      <header>
        <h2>Jerome&#39;s Blog</h2>
        <p>Building my edge cloud using Raspberry PI, keep learning from the opensource community</p>
      </header>
    
    
      <ul class="icons">
        
          
    <li><a href="/index.xml" type="application/rss+xml" target="_blank" title="RSS" class="fa fa-rss"></a></li>


        
        
  <li><a href="//github.com/jbrette" target="_blank" title="GitHub" class="fa fa-github"></a></li>

























  <li><a href="//linkedin.com/in/jerome-brette-109b8711" target="_blank" title="LinkedIn" class="fa fa-linkedin"></a></li>



































  <li><a href="//twitter.com/example" target="_blank" title="Twitter" class="fa fa-twitter"></a></li>




















      </ul>
    
  </section>

  
  <section class="recent-posts">
    <div class="mini-posts">
      <header>
        <h3>Recent Posts</h3>
      </header>
      <div class="posts-container">
        

        
          
        

        
          <article class="mini-post">
            <header>
              <h3>
                <a href="/post/2018-09-28-a/">Upgrade RPI Kubernetes cluster to 1.12</a>
              </h3>
              
              <time class="published" datetime='2018-09-29'>
                September 29, 2018
              </time>
            </header>
            

          </article>
        
          <article class="mini-post">
            <header>
              <h3>
                <a href="/post/2018-08-01-a/">Build and Deploy Kubernetes Hashicorp Vault</a>
              </h3>
              
              <time class="published" datetime='2018-08-01'>
                August 1, 2018
              </time>
            </header>
            

          </article>
        
          <article class="mini-post">
            <header>
              <h3>
                <a href="/post/2018-07-31-a/">Build and Deploy Kubernetes Istio</a>
              </h3>
              
              <time class="published" datetime='2018-07-31'>
                July 31, 2018
              </time>
            </header>
            

          </article>
        
          <article class="mini-post">
            <header>
              <h3>
                <a href="/post/2018-07-30-a/">Build and Deploy Kubernetes test-infra</a>
              </h3>
              
              <time class="published" datetime='2018-07-30'>
                July 30, 2018
              </time>
            </header>
            

          </article>
        
          <article class="mini-post">
            <header>
              <h3>
                <a href="/post/2018-07-29-a/">Build and Deploy Kubernetes Kustomize</a>
              </h3>
              
              <time class="published" datetime='2018-07-29'>
                July 29, 2018
              </time>
            </header>
            

          </article>
        
          <article class="mini-post">
            <header>
              <h3>
                <a href="/post/2018-07-28-a/">Deploy Cassandra on Raspberry-PI 3</a>
              </h3>
              
              <time class="published" datetime='2018-07-28'>
                July 28, 2018
              </time>
            </header>
            

          </article>
        
          <article class="mini-post">
            <header>
              <h3>
                <a href="/post/2018-07-19-a/">Build and Deploy MachineLearning Kubeflow Framework</a>
              </h3>
              
              <time class="published" datetime='2018-07-19'>
                July 19, 2018
              </time>
            </header>
            

          </article>
        
          <article class="mini-post">
            <header>
              <h3>
                <a href="/post/2018-07-18-a/">Compile and Test Portieris</a>
              </h3>
              
              <time class="published" datetime='2018-07-18'>
                July 18, 2018
              </time>
            </header>
            

          </article>
        
          <article class="mini-post">
            <header>
              <h3>
                <a href="/post/2018-07-17-a/">Rebuild Calico for AMD64 ad ARM32V7</a>
              </h3>
              
              <time class="published" datetime='2018-07-17'>
                July 17, 2018
              </time>
            </header>
            

          </article>
        
          <article class="mini-post">
            <header>
              <h3>
                <a href="/post/2018-07-16-a/">Rebuild Hyperkube images</a>
              </h3>
              
              <time class="published" datetime='2018-07-16'>
                July 16, 2018
              </time>
            </header>
            

          </article>
        
      </div>

      
        <a href=
          
            /post/
          
        class="button">View more posts</a>
      
    </div>
  </section>

  
  
  
  
  
    <section id="categories">
      <header>
        <h3>
          <a href="/categories/">Categories</a>
        </h3>
      </header>
        
          
        

        
        <p>
          <article>
            <header>
              
                <a href="/categories/wiki/">wiki</a>
                <span style="float:right;">35</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/wip/">wip</a>
                <span style="float:right;">13</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/news/">news</a>
                <span style="float:right;">2</span>
              
            </header>
          </article>
        </p>
        
    </section>
  
  

  
  
    <section id="mini-bio">
      <h3>About</h3>
      <p>About the author</p>
      <a href="/about/" class="button">Learn More</a>
    </section>
  

  
  <section id="footer">
    
      <ul class="icons">
        
          
    <li><a href="/index.xml" type="application/rss+xml" target="_blank" title="RSS" class="fa fa-rss"></a></li>


        
        
  <li><a href="//github.com/jbrette" target="_blank" title="GitHub" class="fa fa-github"></a></li>

























  <li><a href="//linkedin.com/in/jerome-brette-109b8711" target="_blank" title="LinkedIn" class="fa fa-linkedin"></a></li>



































  <li><a href="//twitter.com/example" target="_blank" title="Twitter" class="fa fa-twitter"></a></li>




















      </ul>
    
    <p class="copyright">
      
        &copy; 2018
        
          Jerome Brette&#39;s Blog
        
      .
      Powered by <a href="//gohugo.io" target="_blank">Hugo</a>
    </p>
  </section>
</section>

    </div>
    <a id="back-to-top" href="#" class="fa fa-arrow-up fa-border fa-2x"></a>
    

    
      
    

    
      
      
      
        <script src="//cdn.bootcss.com/highlight.js/9.11.0/highlight.min.js"></script>
        
        
        
        <script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/r.min.js"></script>
        <script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/yaml.min.js"></script>
        <script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/css.min.js"></script>
        <script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/bash.min.js"></script>
        <script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/python.min.js"></script>
        <script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/golang.min.js"></script>
        <script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>
      
    
    
    
      <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/skel/3.0.1/skel.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.25/jquery.fancybox.min.js"></script>
      <script src="/js/util.js"></script>
      <script src="/js/main.js"></script>
      <script src="/js/backToTop.js"></script>
    

    
      
        
      
    

    
    <script>hljs.initHighlightingOnLoad();</script>
      <script src="//yihui.name/js/math-code.js"></script>
<script async
src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


  </body>
</html>

